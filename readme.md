<div>
  <p align="center">An Lock Free ID Generator for Golang based on Snowflake Algorithm (Twitter announced).</p>
</div>

## Description

An **Lock Free** ID Generator for Golang implementation.

Snowflake is a network service for generating unique ID numbers at high scale with some simple guarantees.

* The first bit is unused sign bit.
* The second part consists of a 48-bit timestamp (milliseconds) whose value is the offset of the current time relative to a certain time.
* The 7 bits machineID, max value is 2^7 -1 = 127.
* The last part consists of 9 bits, its means the length of the serial number generated per millisecond per working node, a maximum of 2^9 -1 = 511 IDs can be generated in the same millisecond.
* The binary length of 48 bits is at most 2^48 -1 millisecond = 8,925 years. So the snowflake algorithm can be used for up to 8,925 years, In order to maximize the use of the algorithm, you should specify a start time for it.

**Performance:**
* Each machine can generate up to **511 IDs per millisecond** (2^9 - 1)
* Maximum **511,000 IDs per second** per machine
* Support up to **127 machines** simultaneously (2^7 - 1)
* Total theoretical capacity: **64,897,000 IDs per second** across all machines

The ID generated by the snowflake algorithm is not guaranteed to be unique. For example, when two different requests enter the same machine at the same time, and the sequence generated by the node is the same, the generated ID will be duplicated.

So if you want use the snowflake algorithm to generate unique ID, You must ensure: The sequence-number generated in the same millisecond of the same node is unique.

Based on this, we created this package and integrated multiple sequence-number providers into it.

* AtomicResolver (base sync/atomic)

> Each provider only needs to ensure that the serial number generated in the same millisecond is different. You can get a unique ID.

## Feature

- ✅ Lock Free
- 🎈 Zero configuration, out of the box
- 🚀 Concurrency safety
- 🌵 Support private ip to machineid
- 🐡 Support custom sequence resolver

## Installation

```shell
$ go get github.com/hedwi/go-snowflake
```

## Usage

1. simple to use.

```go
package main

import (
    "fmt"

    "github.com/hedwi/go-snowflake"
)

func main() {
    id := snowflake.ID()
    fmt.Println(id)
    // 1537200202186752
}
```

2. Specify the MachineID.

```go
package main

import (
    "fmt"

    "github.com/hedwi/go-snowflake"
)

func main() {
    snowflake.SetMachineID(1)

    // Or set private ip to machineid, testing...
    // snowflake.SetMachineID(snowflake.PrivateIPToMachineID())

    id := snowflake.ID()
    fmt.Println(id)
}
```

3. Specify start time.

```go
package main

import (
    "fmt"
    "time"

    "github.com/hedwi/go-snowflake"
)

func main() {
    snowflake.SetStartTime(time.Date(2014, 9, 1, 0, 0, 0, 0, time.UTC))
    id := snowflake.ID()
    fmt.Println(id)
}
```

4. Parse ID.

```go
package main

import (
    "fmt"
    "time"

    "github.com/hedwi/go-snowflake"
)

func main() {
    id := snowflake.ID()
    sid := snowflake.ParseID(id)

    fmt.Println(sid.ID)             // 132271570944000000
    fmt.Println(sid.MachineID)      // 0
    fmt.Println(sid.Sequence)       // 0
    fmt.Println(sid.Timestamp)      // 31536000000
    fmt.Println(sid.GenerateTime()) // 2009-11-10 23:00:00 +0000 UTC
}
```

## Best practices

> ⚠️⚠️ All SetXXX method is thread-unsafe, recommended you call him in the main function.

```go
package main

import (
    "fmt"
    "time"
    "net/http"

    "github.com/hedwi/go-snowflake"
)

func main() {
    snowflake.SetMachineID(1) // change to your machineID
    snowflake.SetStartTime(time.Date(2014, 9, 1, 0, 0, 0, 0, time.UTC))

    http.HandleFunc("/order", submitOrder)
    http.ListenAndServe(":8090", nil)
}

func submitOrder(w http.ResponseWriter, req *http.Request) {
    orderId := snowflake.ID()
    // save order
}
```

## Advanced

Custom sequence resolver. you can customize the sequence-number resolver by following way:

```go
package main

import (
    "fmt"
    "time"

    "github.com/hedwi/go-snowflake"
)

func yourSequenceNumber(ms int64) (uint16, error) {

}

// usage

snowflake.SetSequenceResolver(yourSequenceNumber)
snowflake.ID()
```

### 📊 性能对比：

| 项目 | 原版本 | 新版本 | 变化 |
|------|--------|--------|------|
| 时间戳位数 | 41位 | 48位 | +7位 |
| 机器ID位数 | 10位 | 7位 | -3位 |
| 序列号位数 | 12位 | 9位 | -3位 |
| 生命周期 | 69年 | 8,925年 | +8,856年 |
| 每毫秒ID数 | 4,095 | 511 | -3,584 |
| 每秒ID数 | 4,095,000 | 511,000 | -3,584,000 |
| 最大机器数 | 1,024 | 127 | -897 |


## License

MIT